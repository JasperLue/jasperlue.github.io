<!DOCTYPE html><html lang="null"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"/><meta content="yes" name="apple-mobile-web-app-capable"/><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"/><meta content="telephone=no" name="format-detection"/><meta name="description"/><title>salt-ssh 使用体验 | JasperLue的blog</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"/><link rel="stylesheet" type="text/css" href="/css/pure-min.css"/><link rel="stylesheet" type="text/css" href="/css/grids-responsive-min.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"/><link rel="apple-touch-icon" href="/apple-touch-icon.png"/><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"/><link rel="alternate" type="application/atom+xml" href="/atom.xml"/></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">salt-ssh 使用体验</h1><a id="logo" href="/">JasperLue的blog</a><p class="description"></p></div><div id="nav-menu"><a href="/" class="current"><i class="icon-home"> 首页</i></a><a href="/archives/"><i class="icon-archive"> 归档</i></a><a href="/about/"><i class="icon-about"> 关于我</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post post-page"><h1 class="post-title">salt-ssh 使用体验</h1><div class="post-meta">2015-08-16 | <span class="categories">分类于<a href="/categories/tech/"> tech</a></span></div><span data-thread-key="2015/08/16/salt-ssh 使用体验/" class="ds-thread-count"></span><div class="clear"><div id="toc" class="toc-article"><div class="toc-title">文章目录</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#salt-ssh_安装"><span class="toc-number">1.</span> <span class="toc-text">salt-ssh 安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#salt-ssh使用"><span class="toc-number">2.</span> <span class="toc-text">salt-ssh使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cp模块"><span class="toc-number">2.1.</span> <span class="toc-text">cp模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cmd模块"><span class="toc-number">2.2.</span> <span class="toc-text">cmd模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#file模块"><span class="toc-number">2.3.</span> <span class="toc-text">file模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#network模块"><span class="toc-number">2.4.</span> <span class="toc-text">network模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pkg包管理模块"><span class="toc-number">2.5.</span> <span class="toc-text">pkg包管理模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#service_服务模块"><span class="toc-number">2.6.</span> <span class="toc-text">service 服务模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#More"><span class="toc-number">3.</span> <span class="toc-text">More</span></a></li></ol></div></div><div class="post-content"><p>实习的时候第一次接触到自动化运维的概念。以前运维都是手工部署，对于初创公司还好，当规模增长到一定程度时，服务器早已跨入上千台以上的规模，所以慢慢向脚本化以及批量管理过度。目前很多IT公司都有自己的<code>Paas</code>平台,更高效地达到one-click deployment以及监控的效果。<br>Salt是Saltstack的简称。同类产品有<code>Chef</code>,<code>Ansible</code>等。<br>saltstack项目地址：<a href="https://github.com/saltstack/salt" target="_blank" rel="external">https://github.com/saltstack/salt</a></p>
<p>用python来写的,配置文件采用<code>yaml</code>格式。Salt本身配置简单，所以目前比较看好。要理解Salt，就必须要搞清楚Master和minion的概念。其实就是主从关系，担当master的server来控制多个minion server，从而达到批量部署。<br><a id="more"></a><br>建立主从关系主要靠key认证,在minion端配置其指向的master地址，在master端通过<code>salt-key</code>来对minion端的key认证请求进行操作。 但是目前遇到的问题是minion端在开发测试中经常需要重装，这时候master端仍保留着已经不指向它的minion端的key，所以当重新建立起master和minion端的通信时，此时minion端的key已经变化，所以不能建立通信。需要在master端删除对应minion的key,重新认证。<br>salt-ssh是在0.17.0当中加入的一个功能，引入了新的传输系统，它支持通过SSH通道来实现Salt的通信。它的好处在于使用它不需要安装salt-minion(客户端) 和 salt-master(服务端)只需要安装salt-ssh这个软件包它继承了salt大部分的功能如state、grains、models等。相较与salt,ssh的速度可能稍慢，但是由于十分便捷，一点速度的牺牲无可厚非了。</p>
<h2 id="salt-ssh_安装"><strong>salt-ssh 安装</strong></h2><p>系统是Ubuntu14.04，采用apt-get 来安装。只需要在master端安装就ok<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo  sudo apt-get <span class="operator"><span class="keyword">install</span> <span class="keyword">salt</span>-ssh</span></span><br></pre></td></tr></table></figure></p>
<p>master端的配置文件在/etc/salt/roster,其中配置信息如下：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">web1:</span><br><span class="line">  host: <span class="number">192.168</span><span class="number">.42</span><span class="number">.1</span> <span class="preprocessor"># The IP addr or DNS hostname</span></span><br><span class="line">  user: root         <span class="preprocessor"># minion登录的用户名</span></span><br><span class="line">  passwd: root  <span class="preprocessor"># minion登录的密码</span></span><br><span class="line">  sudo: True         <span class="preprocessor"># root用户权限</span></span><br><span class="line">web2:</span><br><span class="line">  host: <span class="number">192.168</span><span class="number">.42</span><span class="number">.2</span></span><br><span class="line">  user: root         <span class="preprocessor"># minion登录的用户名</span></span><br><span class="line">  passwd: root  <span class="preprocessor"># minion登录的密码</span></span><br><span class="line">  sudo: True         <span class="preprocessor"># root用户权限</span></span><br></pre></td></tr></table></figure></p>
<p>检验salt-ssh是否配置成功：<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt-ssh <span class="string">'*'</span> test.<span class="built_in">ping</span></span><br></pre></td></tr></table></figure></p>
<p>如果返回值为：<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="label">web1:</span></span><br><span class="line">    <span class="literal">True</span></span><br><span class="line"><span class="label">web2:</span></span><br><span class="line">    <span class="literal">True</span></span><br></pre></td></tr></table></figure></p>
<p>那说明配置成功.</p>
<h2 id="salt-ssh使用"><strong>salt-ssh使用</strong></h2><h3 id="cp模块">cp模块</h3><p>实现远程文件、目录的复制，以及下载URL文件等操作.</p>
<ul>
<li><p>将主服务器file_roots指定位置下的目录复制到被控主机</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> cp<span class="class">.get_dir</span> salt:<span class="comment">//hellotest /data</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>将主服务器file_roots指定位置下的文件复制到被控主机</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> cp<span class="class">.get_file</span> salt:<span class="comment">//hellotest/rocketzhang /root/rocketzhang</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>下载指定URL内容到被控主机指定位置</p>
  <figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> cp.get_url <span class="keyword">http</span>://xxx.xyz.com/download/<span class="number">0</span>/<span class="built_in">files</span>.tgz /root/<span class="built_in">files</span>.tgz</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="cmd模块">cmd模块</h3><ul>
<li><p>实现远程的命令行调用执行</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> cmd<span class="class">.run</span> <span class="string">'netstat -ntlp'</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="file模块">file模块</h3><ul>
<li><p>被控主机文件常见操作，包括文件读写、权限、查找、校验等</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> file<span class="class">.get_sum</span> /etc/resolv<span class="class">.conf</span> md5</span><br><span class="line">salt <span class="string">'*'</span> file<span class="class">.stats</span> /etc/resolv.conf</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="network模块">network模块</h3><ul>
<li><p>返回被控主机网络信息</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> network<span class="class">.ip_addrs</span></span><br><span class="line">salt <span class="string">'*'</span> network.interfaces</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="pkg包管理模块">pkg包管理模块</h3><ul>
<li><p>被控主机程序包管理，如yum、apt-get等</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> pkg<span class="class">.install</span> nmap</span><br><span class="line">salt <span class="string">'*'</span> pkg<span class="class">.file_list</span> nmap</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="service_服务模块">service 服务模块</h3><ul>
<li><p>被控主机程序包服务管理</p>
  <figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">salt <span class="string">'*'</span> service<span class="class">.enable</span> crond</span><br><span class="line">salt <span class="string">'*'</span> service<span class="class">.disable</span> crond</span><br><span class="line">salt <span class="string">'*'</span> service<span class="class">.status</span> crond</span><br><span class="line">salt <span class="string">'*'</span> service<span class="class">.stop</span> crond</span><br><span class="line">salt <span class="string">'*'</span> service<span class="class">.start</span> crond</span><br><span class="line">salt <span class="string">'*'</span> service<span class="class">.restart</span> crond</span><br><span class="line">salt <span class="string">'*'</span> service<span class="class">.reload</span> crond</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="More"><strong>More</strong></h2><p>更多的功能，比如：grains、pillar、states、modules、returner、runners、reactor等，还有如下高级命令的使用，以及模板配置的渲染、扩展模块的二次开发等，可以参见<a href="http://xiaorui.cc/2014/04/12/saltstack的教程、例子、资料/" target="_blank" rel="external">xiaorui的博客</a></p>
</div><div class="tags"><a href="/tags/Salt/">Salt</a></div><div class="post-nav"><a href="/2015/09/29/Docker-入门/" class="pre"><i class="icon-previous">Docker 入门</i></a><a href="/2015/08/15/第一篇：Hello-world/" class="next">第一篇：Hello World<i class="icon-next"></i></a></div><div data-thread-key="2015/08/16/salt-ssh 使用体验/" data-title="salt-ssh 使用体验" data-url="http://JasperLue.github.io/2015/08/16/salt-ssh 使用体验/" class="ds-share flat"><div class="ds-share-inline"><ul class="ds-share-icons-16"><li data-toggle="ds-share-icons-more"><a href="javascript:void(0);" class="ds-more">分享到：</a></li><li><a href="javascript:void(0);" data-service="weibo" class="ds-weibo">微博</a></li><li><a href="javascript:void(0);" data-service="qzone" class="ds-qzone">QQ空间</a></li><li><a href="javascript:void(0);" data-service="qqt" class="ds-qqt">腾讯微博</a></li><li><a href="javascript:void(0);" data-service="wechat" class="ds-wechat">微信</a></li></ul><div class="ds-share-icons-more"></div></div></div><div data-thread-key="2015/08/16/salt-ssh 使用体验/" data-title="salt-ssh 使用体验" data-url="http://JasperLue.github.io/2015/08/16/salt-ssh 使用体验/" data-author-key="1" class="ds-thread"></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><div class="widget-title">分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/life/">life</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/">tech</a></li></ul></div><div class="widget"><div class="widget-title">标签</div><div class="tagcloud"><a href="/tags/随笔/" style="font-size: 15px;">随笔</a> <a href="/tags/Salt/" style="font-size: 15px;">Salt</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a></div></div><div class="widget"><div class="widget-title">最新文章</div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2015/10/15/Python技巧/">Python技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/09/29/Docker-入门/">Docker 入门</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/16/salt-ssh 使用体验/">salt-ssh 使用体验</a></li><li class="post-list-item"><a class="post-list-link" href="/2015/08/15/第一篇：Hello-world/">第一篇：Hello World</a></li></ul></div><div class="widget"><div class="comments-title">最近评论</div><div data-num-items="5" data-show-avatars="0" data-show-time="1" data-show-admin="0" data-excerpt-length="32" data-show-title="1" class="ds-recent-comments"></div></div><div class="widget"><div class="widget-title">友情链接</div><ul></ul><a href="http://weibo.com/lvjinpeng/" title="我的微博" target="_blank">我的微博</a><ul></ul><a href="https://github.com/JasperLue" title="github" target="_blank">github</a><ul></ul><a href="http://www.zhihu.com/people/shanghai" title="知乎" target="_blank">知乎</a></div></div></div></div><div id="footer">© <a href="/" rel="nofollow">JasperLue的blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div><a id="rocket" href="#top" class="show"></a><script src="/js/jquery.min.js" type="text/javascript"></script>
<script src="/js/totop.js" type="text/javascript"></script><script src="/js/fancybox.pack.js" type="text/javascript"></script>
<script src="/js/jquery.fancybox.js" type="text/javascript"></script><link rel="stylesheet" href="/css/jquery.fancybox.css" type="text/css"><script>var duoshuoQuery = {short_name:'Jasperlue'};
(function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0]
        || document.getElementsByTagName('body')[0]).appendChild(ds);
})();
</script></div></body></html>